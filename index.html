<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	
	<title>Overdrive delicous.com</title>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"> </script>

<script type="text/javascript">


function LocalStorage(){
	this.DB_VERSION="0.1";
	this.DB_NAME="delicious overdrive";
	this.db = openDatabase("overdrive delicious.com", "0.1");
	this.tableList=["bookmarks", "settings"];
	
	/**
	* This block checks if the database exists and creates the necesarry tables.
	*/
	this.db.transaction(function(tx) {
        tx.executeSql("SELECT COUNT(*) FROM bookmarks", [], function(result) { alert("tables exist");}, function(tx, error) {
			tx.executeSql("CREATE TABLE bookmarks (url TEXT NOT NULL UNIQUE, title TEXT, tags TEXT)",[],
			function(result) { 
                alert("tables created");
            });
			tx.executeSql("CREATE TABLE settings (id TEXT NOT NULL UNIQUE, type TEXT, value TEXT)", [],
			function(result) { 
                alert("tables created");
            },
			function(tx, error) { 
                alert("Could not create tables.");
            });
        });
    });
	
	this.deleteTables=function ()	{
	    
		this.db.transaction(function(tx) {
	        for (i=0; i<this.tableList.length; i++){
				tx.executeSql("DROP TABLE ?", [this.tableList[i]], 
				function(result) { }, 
				function(tx, error) { 
				});
			}
				
		});
		
	}
	
	
	/**
	* Returns one of the settings values in the local storage.
	*/ 
	this.getSetting=function(key){
		
		return value;
	}
	
	this.insertBookmark= function(url, title, tags) {
		
		var tagsString="";
		$.each(tags, function() {
		      tagsString+=this+",";
		    });
		
		this.db.transaction(function(tx){
			     tx.executeSql("INSERT INTO bookmarks (url, title, tags) VALUES (?,?,?)",[url, title, tagsString], 			
				 function(tx, result){       
			     }, 
				 function(tx, error){
			     	 alert('Could not insert bookmark: ' + error.message);
			     });
		});
	}
}

function searchBookmarks(term) 
{

	db.transaction(function(tx) 
	{
		db.transaction(function(tx) 
		{
		     tx.executeSql("SELECT * FROM bookmark",[], function(tx, result) 
			{
		            
					alert(result.rows.length);

		            if (!result.rows.length)
					{
						alert("no matches");
					}
		                
		        }, function(tx, error) 
				{
		            alert('Failed to retrieve bookmarks from database - ' + error.message);
		            return;
		        });
		});
	});	
}

$(document).ready(function(){
	
    var storage = new LocalStorage();
	
	
	var username="veggieboy4000";
	var url="http://feeds.delicious.com/v1/json/"+username+"?raw&count=100";
	
	$.getJSON(url+"&callback=?", function(bookmarks){
		$.each(bookmarks, function(){
		    $("#content").append("<li><a href='"+this.u+"'>"+this.d+"</a></li>");
			storage.insertBookmark(this.u, this.d, this.t);
		});
   	});
	
	
	
	
	
});
</script>
	
</head>

<body>
<ul id="content">
</ul>

</body>
</html>
